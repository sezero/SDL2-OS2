#
#  This is an OpenWatcom makefile to build SDL2 for OS/2
#
#  Andrey Vasilkin (Digi), 2016.
#

LIBNAME = SDL2
VERSION = 2.0.5a
DESCRIPTION = Simple DirectMedia Layer 2
DESCRIPTION+= (OS/2 port by Andrey Vasilkin)

LIBHOME = os2
LIBPATH = $(LIBHOME)/lib
DLLFILE = $(LIBHOME)/$(LIBNAME).dll
LIBFILE = $(LIBHOME)/$(LIBNAME).lib
LNKFILE = $(LIBNAME).lnk

INCPATH = -I$(%WATCOM)/h/os2 -I$(%WATCOM)/h
INCPATH+= -I$(LIBHOME)/h
INCPATH+= -Iinclude -Isrc/core/os2 -Isrc/core/os2/geniconv

SRCS = SDL.c SDL_assert.c SDL_error.c SDL_log.c SDL_hints.c
SRCS+= SDL_getenv.c SDL_iconv.c SDL_malloc.c SDL_qsort.c SDL_stdlib.c SDL_string.c
SRCS+= SDL_cpuinfo.c SDL_atomic.c SDL_spinlock.c SDL_thread.c SDL_timer.c
SRCS+= SDL_rwops.c SDL_power.c
SRCS+= SDL_audio.c SDL_audiocvt.c SDL_audiodev.c SDL_audiotypecvt.c SDL_mixer.c SDL_wave.c
SRCS+= SDL_events.c SDL_quit.c SDL_keyboard.c SDL_mouse.c SDL_windowevents.c &
       SDL_clipboardevents.c SDL_dropevents.c SDL_gesture.c SDL_touch.c
SRCS+= SDL_haptic.c SDL_gamecontroller.c SDL_joystick.c
SRCS+= SDL_render.c SDL_yuv_mmx.c SDL_yuv_sw.c SDL_blendfillrect.c &
       SDL_blendline.c SDL_blendpoint.c SDL_drawline.c SDL_drawpoint.c &
       SDL_render_sw.c SDL_rotate.c
SRCS+= SDL_blit.c SDL_blit_0.c SDL_blit_1.c SDL_blit_A.c SDL_blit_auto.c &
       SDL_blit_copy.c SDL_blit_N.c SDL_blit_slow.c SDL_fillrect.c SDL_bmp.c &
       SDL_pixels.c SDL_rect.c SDL_RLEaccel.c SDL_shape.c SDL_stretch.c &
       SDL_surface.c SDL_video.c SDL_clipboard.c SDL_egl.c

SRCS+= SDL_os2.c geniconv.c os2cp.c os2iconv.c sys2utf8.c
SRCS+= SDL_syscond.c SDL_sysmutex.c SDL_syssem.c SDL_systhread.c &
       SDL_systimer.c SDL_systls.c SDL_sysloadso.c SDL_syspower.c &
       SDL_sysfilesystem.c
SRCS+= SDL_os2audio.c
SRCS+= SDL_syshaptic.c SDL_sysjoystick.c
SRCS+= SDL_os2video.c SDL_os2util.c SDL_os2dive.c SDL_os2vman.c &
       SDL_os2mouse.c SDL_os2messagebox.c

SRCS+= SDL_dummyaudio.c SDL_diskaudio.c
SRCS+= SDL_nullvideo.c SDL_nullframebuffer.c SDL_nullevents.c

SRCS+= SDL_dynapi.c


OBJS = $(SRCS:.c=.obj)

PMGRE_LIB = $(LIBPATH)/pmgre.lib
PMGRE_DEF = $(LIBPATH)/pmgre.def
PMGRE_EXP = $(LIBPATH)/pmgre.exp

LIBS = mmpm2.lib libuls.lib libconv.lib
# $(PMGRE_LIB)

CFLAGS = -bt=os2 -d0 -q -bm -5s -fp5 -fpi87 -sg -oteanbmier -ei

# max warnings:
CFLAGS+= -wx
# building dll:
CFLAGS+= -bd
# the include paths :
CFLAGS+= $(INCPATH)
# building SDL itself:
CFLAGS+= -DBUILD_SDL

# Debug options:
# - debug messages from OS/2 related code to stdout:
#CFLAGS+= -DOS2DEBUG
# - debug messages from OS/2 code via SDL_LogDebug():
#CFLAGS+= -DOS2DEBUG=2


.extensions:
.extensions: .lib .dll .obj .c .asm

.c: ./src;./src/core/os2;./src/core/os2/geniconv;./src/dynapi;./src/audio;./src/cpuinfo;./src/events;./src/file;./src/haptic;./src/joystick;./src/power;./src/render;./src/render/software;./src/stdlib;./src/thread;./src/timer;./src/video;./src/video/yuv2rgb;./src/audio/os2;./src/haptic/dummy;./src/joystick/dummy;./src/loadso/os2;./src/filesystem/os2;./src/thread/os2;./src/thread/generic;./src/timer/os2;./src/video/os2;./src/power;./src/power/os2;./src/atomic;./src/audio/dummy;./src/audio/disk;./src/video/dummy;./src/test;

all: $(DLLFILE) $(LIBFILE) .symbolic

$(DLLFILE): info_compiling $(OBJS) $(LNKFILE)
# $(PMGRE_LIB)
    @echo * Linking: $@
    wlink @$(LNKFILE)

$(LIBFILE): $(DLLFILE)
    @echo * Creating LIB file: $@
    wlib -q -b -n -c -pa -s -t -zld -ii -io $* $(DLLFILE)

.c.obj:
    wcc386 $(CFLAGS) -fo=$^@ $<

SDL_cpuinfo.obj: SDL_cpuinfo.c
    wcc386 $(CFLAGS) -wcd=200 -fo=$^@ $<

SDL_rwops.obj: SDL_rwops.c
    wcc386 $(CFLAGS) -wcd=136 -fo=$^@ $<

SDL_blendfillrect.obj: SDL_blendfillrect.c
    wcc386 $(CFLAGS) -wcd=200 -fo=$^@ $<

SDL_blendline.obj: SDL_blendline.c
    wcc386 $(CFLAGS) -wcd=200 -fo=$^@ $<

SDL_blendpoint.obj: SDL_blendpoint.c
    wcc386 $(CFLAGS) -wcd=200 -fo=$^@ $<

SDL_RLEaccel.obj: SDL_RLEaccel.c
    wcc386 $(CFLAGS) -wcd=201 -fo=$^@ $<

$(PMGRE_LIB): $(PMGRE_EXP)
	wlib -q -b -n -c -pa -s -t -zld -ii -io $(PMGRE_LIB) @$(PMGRE_EXP)

$(PMGRE_EXP): $(PMGRE_DEF) $(LIBPATH)/def2lbc.sed
	@echo * Creating PMGRE import library
	sed -f $(LIBPATH)/def2lbc.sed $(PMGRE_DEF) > $(PMGRE_EXP)

$(LNKFILE):
#   About LIBPATH: OpenWatcom's library os2386.lib does not contain entries
#   Gre32Entry1..Gre32Entry10. We need os2386.lib from IBM OS/2 developer's
#   toolkit. %LIB% should contain path item like  xxxx/OS2TK45/lib  if you
#   have the toolkit installed.
    @echo * Creating linker file: $@
    @%create $@
    @%append $@ SYSTEM os2v2_dll INITINSTANCE TERMINSTANCE
    @%append $@ NAME $(LIBHOME)/$(LIBNAME)
    @for %i in ($(OBJS)) do @%append $@ FILE %i
    @%append $@ LIBPATH $(%LIB);$(LIBPATH)
    @for %i in ($(LIBS)) do @%append $@ LIB %i
    @%append $@ OPTION QUIET
    @%append $@ OPTION IMPF=$(LIBHOME)/$^&.exp
    @%append $@ OPTION MAP=$(LIBHOME)/$^&.map
!ifdef %osdir
    @$(%osdir)/KLIBC/BIN/date +"OPTION DESCRIPTION '@$#libsdl org:$(VERSION)$#@$#$#1$#$# %F               $(%HOSTNAME)::::::@@$(DESCRIPTION)'" >>$^@
!else
    @%append $@ OPTION DESCRIPTION '@$#libsdl org:$(VERSION)$#@$(DESCRIPTION)'
!endif
    @%append $@ OPTION QUIET
    @%append $@ OPTION ELIMINATE
    @%append $@ OPTION MANYAUTODATA
    @%append $@ OPTION OSNAME='OS/2 and eComStation'
    @%append $@ OPTION SHOWDEAD

clean: .SYMBOLIC
    @ echo * Clean: $(LIBNAME)
    @if exist *.obj rm *.obj
    @if exist ./obj/*.obj rm ./obj/*.obj
    @if exist *.err rm *.err
    @if exist $(LIBHOME)/*.map rm $(LIBHOME)/*.map
    @if exist $(LNKFILE) rm $(LNKFILE)
    @if exist $(LIBPATH)/pmgre.exp rm $(PMGRE_EXP)
    @if exist $(LIBPATH)/pmgre.lib rm $(PMGRE_LIB)

distclean: .SYMBOLIC clean
    @if exist $(LIBHOME)/*.exp rm $(LIBHOME)/*.exp
    @if exist $(DLLFILE) rm $(DLLFILE)
    @if exist $(LIBFILE) rm $(LIBFILE)

info_compiling: .symbolic
    @echo * Compiling...
